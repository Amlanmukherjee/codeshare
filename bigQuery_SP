CREATE OR REPLACE PROCEDURE `gcp-ee-wda-uat.gcp_wda_dw.usp_dw_faap`()
BEGIN
  DECLARE EmpPositionIdentifier STRING;
  DECLARE SupPositionIdentifier STRING;
  DECLARE FaapPlanName STRING;

  -- Get the latest employee profile date
  SET EmpPositionIdentifier = (
    SELECT MAX(EmployeeProfileAsOfDate)
    FROM gcp_wda_dw.Employee_Profile
  );

  FOR Position AS 
    SELECT
      CASE 
        WHEN INSTR(PositionIdentifierNumber, '_') > 0 THEN SUBSTR(PositionIdentifierNumber, 1, INSTR(PositionIdentifierNumber, '_') - 1)
        WHEN INSTR(PositionIdentifierNumber, ' ') > 0 THEN SUBSTR(PositionIdentifierNumber, 1, INSTR(PositionIdentifierNumber, ' ') - 1)
        ELSE PositionIdentifierNumber
      END AS PositionIdentifierNumber
    FROM gcp-ee-wda-dev.gcp_wda_work.stg_TBPREQUISITION_STG
  DO
    SET SupPositionIdentifier = Position.PositionIdentifierNumber;
    label_1: LOOP
      SET (
        EmpPositionIdentifier,
        SupPositionIdentifier,
        FaapPlanName
      ) = (
        SELECT
          EMP.Emp_PositionIdentifierNumber,
          POS1.PositionIdentifierNumber AS Sup_PositionIdentifierNumber,
          FAAP.PlanName AS Faap_PlanName
        FROM gcp_wda_dw.Position AS POS
        JOIN gcp_wda_dw.Employee_Profile AS EMP
          ON POS.Employee_Position.EmployeeSystemNumber = EMP.EmployeeSystemNumber
          AND DATE(POS.PositionAsOfDate) = DATE(EMP.EmployeeProfileAsOfDate)
        JOIN gcp_wda_dw.Position AS POS1
          ON POS1.Employee_Position.EmployeeSystemNumber = POS.Employee_Position.SupervisorEmployeeSystemNumber 
          AND DATE(POS1.PositionAsOfDate) = DATE(POS.PositionAsOfDate)
        JOIN gcp-ee-wda-dev.gcp_wda_work.FAAP_Hierarchy FAAP
          ON CASE 
              WHEN INSTR(FAAP.PositionCode, '_') > 0 THEN SUBSTR(FAAP.PositionCode, 1, INSTR(FAAP.PositionCode, '_') - 1)
              WHEN INSTR(FAAP.PositionCode, ' ') > 0 THEN SUBSTR(FAAP.PositionCode, 1, INSTR(FAAP.PositionCode, ' ') - 1)
              ELSE FAAP.PositionCode
            END = CASE 
              WHEN INSTR(POS1.PositionIdentifierNumber, '_') > 0 THEN SUBSTR(POS1.PositionIdentifierNumber, 1, INSTR(POS1.PositionIdentifierNumber, '_') - 1)
              WHEN INSTR(POS1.PositionIdentifierNumber, ' ') > 0 THEN SUBSTR(POS1.PositionIdentifierNumber, 1, INSTR(POS1.PositionIdentifierNumber, ' ') - 1)
              ELSE POS1.PositionIdentifierNumber
            END
        WHERE
          EMP.EmployeeProfileAsOfDate = EmpPositionIdentifier
          AND POS.bq_logical_delete_indicator = 0
          AND EMP.bq_logical_delete_indicator = 0
          AND POS.PositionAsOfDate = (SELECT MAX(PositionAsOfDate) FROM gcp_wda_dw.Position)
          AND POS1.PositionAsOfDate = (SELECT MAX(PositionAsOfDate) FROM gcp_wda_dw.Position)
          AND LOWER(EMP.EmployeeStatusDescriptionText) IN ('active')
          AND CASE 
            WHEN INSTR(POS.PositionIdentifierNumber, '_') > 0 THEN SUBSTR(POS.PositionIdentifierNumber, 1, INSTR(POS.PositionIdentifierNumber, '_') - 1)
            WHEN INSTR(POS.PositionIdentifierNumber, ' ') > 0 THEN SUBSTR(POS.PositionIdentifierNumber, 1, INSTR(POS.PositionIdentifierNumber, ' ') - 1)
            ELSE POS.PositionIdentifierNumber
          END = Position.PositionIdentifierNumber
        LIMIT 1
      );

      IF FaapPlanName IS NULL THEN
        SET SupPositionIdentifier = Sup_PositionIdentifierNumber;
      ELSE
        LEAVE label_1;
      END IF;
    END LOOP label_1;
  END FOR;
END;
